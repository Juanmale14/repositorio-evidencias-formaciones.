<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio de Evidencias de Nuestra Formaci√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3b82f6;
            --primary-light: #93c5fd;
            --primary-dark: #1d4ed8;
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-color) 0%, #e2e8f0 100%);
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .session-control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--primary-color);
        }

        .session-control-panel h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }

        .session-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .session-info-item {
            text-align: center;
        }

        .session-info-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .session-id-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .session-id {
            font-family: monospace;
            background: #f1f5f9;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid var(--primary-light);
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .copy-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .session-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-panel {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid var(--primary-light);
        }

        .role-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .role-btn {
            padding: 10px 20px;
            border: 2px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .role-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .role-btn:hover:not(.active) {
            background: var(--primary-light);
            color: white;
        }

        .presenter-controls, .participant-controls {
            text-align: center;
        }

        .theme-selector {
            margin: 20px 0;
        }

        .theme-selector label {
            font-weight: 600;
            margin-right: 10px;
        }

        .color-picker {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .session-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--primary-color);
            color: white;
        }

        .control-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .control-btn.inactive {
            background: #ef4444;
        }

        .control-btn.inactive:hover {
            background: #dc2626;
        }

        .session-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.9rem;
        }

        .session-id {
            font-family: monospace;
            background: white;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-weight: bold;
            color: var(--primary-color);
        }

        .participant-count {
            color: #64748b;
            font-weight: 600;
        }

        .connection-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .session-input {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            font-family: monospace;
            width: 250px;
        }

        .session-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .connection-status {
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .connection-status.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .connection-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .participation-notice {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            color: #92400e;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--text-color);
        }

        .tab-button.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: var(--primary-light);
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid var(--primary-light);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .submit-btn {
            background: var(--primary-color);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .evidence-display {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            background: #fafafa;
        }

        .evidence-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 5px solid;
            transition: transform 0.2s ease;
        }

        .evidence-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .evidence-card h3 {
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 1.2rem;
        }

        .evidence-card a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            word-break: break-all;
        }

        .evidence-card a:hover {
            text-decoration: underline;
        }

        .evidence-card .timestamp {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 10px;
            font-style: italic;
        }

        .export-section {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: #10b981;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .export-btn.pdf {
            background: #dc2626;
        }

        .export-btn.pdf:hover {
            background: #b91c1c;
        }

        .no-evidence {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 40px;
        }

        .card-colors {
            --card-1: #fef3c7;
            --card-2: #ddd6fe;
            --card-3: #fce7f3;
            --card-4: #d1fae5;
            --card-5: #fed7d7;
            --card-6: #bfdbfe;
            --card-7: #fde68a;
            --card-8: #c7d2fe;
        }

        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .qr-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .qr-modal h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .qr-code-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }

        .qr-modal .control-btn {
            margin: 10px 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .export-section {
                flex-direction: column;
            }

            .session-info-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .session-actions {
                flex-direction: column;
                align-items: center;
            }

            .session-actions .control-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
<style type="text/css">
.grande { font-size: 60px; }
</style>
<script>
// Escribir aqui el c√≥digo Javascript
</script>
<style>
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        </style></head>
<body>
    <div class="container">
        <div class="header">
            <h1>Repositorio de Evidencias de Nuestra Formaci√≥n</h1>
            <p>Recopila y comparte evidencias de aprendizaje en tiempo real</p>
        </div>

        <div id="sessionControlPanel" class="session-control-panel" style="display: block;">
            <h3>üéõÔ∏è Control de Sesi√≥n</h3>
            <div class="session-info-grid">
                <div class="session-info-item">
                    <label>ID de Sesi√≥n:</label>
                    <div class="session-id-display">
                        <span id="sessionIdDisplay" class="session-id">e2720b52-9345-44ca-afcf-22164e83b80a</span>
                        <button id="copySessionIdBtn" class="copy-btn" title="Copiar ID">üìã</button>
                    </div>
                </div>
                <div class="session-info-item">
                    <label>Participantes:</label>
                    <span id="participantCountDisplay" class="participant-count">0 conectados</span>
                </div>
            </div>
            <div class="session-actions">
                <button id="generateLinkBtn" class="control-btn">üîó Generar enlace de sesi√≥n</button>
                <button id="generateQRBtn" class="control-btn">üì± Generar QR para participantes</button>
                <button id="toggleParticipationBtn" class="control-btn active">‚úÖ Participaci√≥n activa</button>
            </div>
        </div>

        <div class="control-panel">
                <div class="role-selector">
                    <button id="presenterBtn" class="role-btn active">üë®‚Äçüè´ Presentador</button>
                    <button id="participantBtn" class="role-btn">üë• Participante</button>
                </div>
                
                <div id="presenterControls" class="presenter-controls" style="display: block;">
                    <div class="theme-selector">
                        <label for="colorPicker">Color del tema:</label>
                        <input type="color" id="colorPicker" class="color-picker" value="#3b82f6">
                    </div>
                </div>
                
                <div id="participantControls" class="participant-controls" style="display: none;">
                    <div class="connection-section">
                        <input type="text" id="sessionIdInput" placeholder="Introduce el ID de sesi√≥n" class="session-input">
                        <button id="connectBtn" class="control-btn">üîå Conectar a sesi√≥n</button>
                        <div id="connectionStatus" class="connection-status disconnected">Desconectado</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button" onclick="switchTab('evidencias')">üìù Evidencias</button>
            <button class="tab-button active" onclick="switchTab('resumen')">üìä Resumen Final</button>
        </div>

        <div id="evidencias" class="tab-content">
            <h2 style="margin-bottom: 20px; color: var(--primary-color);">Nuestras evidencias del aprendizaje en esta formaci√≥n</h2>
            
            <div id="participationNotice" class="participation-notice" style="display: none;">
                <p>‚è∏Ô∏è La participaci√≥n est√° pausada por el presentador. Espera a que se reactive para enviar evidencias.</p>
            </div>

            <div class="form-section" id="evidenceFormSection" style="opacity: 1; pointer-events: auto;">
                <form id="evidenceForm">
                    <div class="form-group">
                        <label for="evidenceTitle">T√≠tulo de la Evidencia:</label>
                        <input type="text" id="evidenceTitle" required="" placeholder="Ej: Proyecto final de m√≥dulo 1">
                    </div>
                    
                    <div class="form-group">
                        <label for="evidenceUrl">URL de la Evidencia:</label>
                        <input type="url" id="evidenceUrl" required="" placeholder="https://ejemplo.com/mi-evidencia">
                    </div>
                    
                    <button type="submit" class="submit-btn">üì§ Enviar mi evidencia</button>
                </form>
            </div>

            <div class="evidence-display" id="evidenceDisplay"><div class="no-evidence">No hay evidencias enviadas a√∫n. ¬°S√© el primero en compartir!</div></div>
        </div>

        <div id="resumen" class="tab-content active">
            <h2 style="margin-bottom: 20px; color: var(--primary-color);">Resumen Final de Evidencias</h2>
            
            <div class="export-section">
                <button class="export-btn pdf" onclick="exportToPDF()">üìÑ Exportar a PDF</button>
                <button class="export-btn" onclick="exportToCSV()">üìä Exportar a CSV</button>
            </div>

            <div class="evidence-display" id="summaryDisplay"><div class="no-evidence">No hay evidencias para mostrar en el resumen.</div></div>
        </div>
    

    <!-- QR Modal -->
    <div id="qrModal" class="qr-modal">
        <div class="qr-modal-content">
            <h3>üì± C√≥digo QR para Participantes</h3>
            <p>Escanea este c√≥digo para unirte a la sesi√≥n:</p>
            <div class="qr-code-container" id="qrCodeContainer"></div>
            <div>
                <button class="control-btn" onclick="downloadQR()">üíæ Descargar QR</button>
                <button class="control-btn" onclick="closeQRModal()">‚ùå Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let evidences = [];
        const cardColors = ['#fef3c7', '#ddd6fe', '#fce7f3', '#d1fae5', '#fed7d7', '#bfdbfe', '#fde68a', '#c7d2fe'];
        let peer = null;
        let connections = [];
        let isPresenter = true;
        let participationActive = true;
        let sessionConfig = {
            themeColor: '#3b82f6',
            title: 'Repositorio de Evidencias de Nuestra Formaci√≥n'
        };
        let currentQRCanvas = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadConfigFromURL();
        });

        function initializeApp() {
            updateDisplays();
            updateRoleDisplay();
            
            // Load theme color from session config
            const savedColor = sessionConfig.themeColor;
            document.getElementById('colorPicker').value = savedColor;
            updateThemeColor(savedColor);
        }

        function setupEventListeners() {
            // Role selection
            document.getElementById('presenterBtn').addEventListener('click', () => switchRole(true));
            document.getElementById('participantBtn').addEventListener('click', () => switchRole(false));
            
            // Theme color picker
            document.getElementById('colorPicker').addEventListener('change', function(e) {
                updateThemeColor(e.target.value);
                if (isPresenter) {
                    sessionConfig.themeColor = e.target.value;
                    broadcastConfigUpdate();
                }
            });

            // Presenter controls
            document.getElementById('generateLinkBtn').addEventListener('click', generateSessionLink);
            document.getElementById('generateQRBtn').addEventListener('click', generateQRCode);
            document.getElementById('toggleParticipationBtn').addEventListener('click', toggleParticipation);
            document.getElementById('copySessionIdBtn').addEventListener('click', copySessionId);
            
            // Participant controls
            document.getElementById('connectBtn').addEventListener('click', connectToSession);

            // Form submission
            document.getElementById('evidenceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (participationActive || isPresenter) {
                    addEvidence();
                } else {
                    showNotification('La participaci√≥n est√° pausada', 'warning');
                }
            });
        }

        function loadConfigFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const config = urlParams.get('config');
            
            if (config) {
                try {
                    const decodedConfig = JSON.parse(atob(config));
                    sessionConfig = { ...sessionConfig, ...decodedConfig };
                    
                    // Apply loaded configuration
                    document.getElementById('colorPicker').value = sessionConfig.themeColor;
                    updateThemeColor(sessionConfig.themeColor);
                    
                    if (sessionConfig.sessionId) {
                        document.getElementById('sessionIdInput').value = sessionConfig.sessionId;
                        switchRole(false); // Switch to participant mode
                        setTimeout(() => connectToSession(), 1000);
                    }
                } catch (e) {
                    console.error('Error loading configuration:', e);
                }
            }
        }

        function switchRole(presenter) {
            isPresenter = presenter;
            
            // Update button states
            document.getElementById('presenterBtn').classList.toggle('active', presenter);
            document.getElementById('participantBtn').classList.toggle('active', !presenter);
            
            updateRoleDisplay();
            
            if (presenter) {
                initializePresenter();
            } else {
                initializeParticipant();
            }
        }

        function updateRoleDisplay() {
            document.getElementById('presenterControls').style.display = isPresenter ? 'block' : 'none';
            document.getElementById('participantControls').style.display = isPresenter ? 'none' : 'block';
            document.getElementById('sessionControlPanel').style.display = isPresenter ? 'block' : 'none';
            
            // Update form section visibility based on participation status
            updateParticipationStatus();
        }

        function initializePresenter() {
            if (peer) {
                peer.destroy();
            }
            
            peer = new Peer();
            
            peer.on('open', function(id) {
                document.getElementById('sessionIdDisplay').textContent = id;
                sessionConfig.sessionId = id;
                showNotification('Sesi√≥n de presentador iniciada');
            });
            
            peer.on('connection', function(conn) {
                connections.push(conn);
                updateParticipantCount();
                
                conn.on('data', function(data) {
                    if (data.type === 'evidence') {
                        receiveEvidence(data.evidence);
                    }
                });
                
                conn.on('close', function() {
                    connections = connections.filter(c => c !== conn);
                    updateParticipantCount();
                });
                
                // Send current configuration to new participant
                conn.send({
                    type: 'config',
                    config: sessionConfig,
                    participationActive: participationActive,
                    evidences: evidences
                });
            });
        }

        function initializeParticipant() {
            if (peer) {
                peer.destroy();
            }
            
            peer = new Peer();
            updateConnectionStatus('disconnected');
        }

        function connectToSession() {
            const sessionId = document.getElementById('sessionIdInput').value.trim();
            
            if (!sessionId) {
                showNotification('Introduce un ID de sesi√≥n v√°lido', 'error');
                return;
            }
            
            if (!peer) {
                initializeParticipant();
            }
            
            peer.on('open', function() {
                const conn = peer.connect(sessionId);
                
                conn.on('open', function() {
                    connections = [conn];
                    updateConnectionStatus('connected');
                    showNotification('Conectado a la sesi√≥n');
                });
                
                conn.on('data', function(data) {
                    if (data.type === 'config') {
                        sessionConfig = data.config;
                        participationActive = data.participationActive;
                        evidences = data.evidences || [];
                        
                        // Apply received configuration
                        updateThemeColor(sessionConfig.themeColor);
                        updateParticipationStatus();
                        updateDisplays();
                    } else if (data.type === 'evidence') {
                        receiveEvidence(data.evidence);
                    } else if (data.type === 'participationToggle') {
                        participationActive = data.active;
                        updateParticipationStatus();
                    } else if (data.type === 'configUpdate') {
                        sessionConfig = { ...sessionConfig, ...data.config };
                        updateThemeColor(sessionConfig.themeColor);
                    }
                });
                
                conn.on('close', function() {
                    connections = [];
                    updateConnectionStatus('disconnected');
                    showNotification('Desconectado de la sesi√≥n', 'warning');
                });
                
                conn.on('error', function(err) {
                    updateConnectionStatus('disconnected');
                    showNotification('Error de conexi√≥n: ' + err.message, 'error');
                });
            });
        }

        function generateSessionLink() {
            if (!sessionConfig.sessionId) {
                showNotification('Primero inicia la sesi√≥n como presentador', 'error');
                return;
            }
            
            const config = btoa(JSON.stringify({
                sessionId: sessionConfig.sessionId,
                themeColor: sessionConfig.themeColor,
                title: sessionConfig.title
            }));
            
            const link = `${window.location.origin}${window.location.pathname}?config=${config}`;
            
            copyToClipboard(link, 'Enlace copiado al portapapeles');
        }

        function copySessionId() {
            if (!sessionConfig.sessionId) {
                showNotification('No hay ID de sesi√≥n disponible', 'error');
                return;
            }
            
            copyToClipboard(sessionConfig.sessionId, 'ID de sesi√≥n copiado');
        }

        function copyToClipboard(text, successMessage) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification(successMessage);
                }).catch(() => {
                    fallbackCopyToClipboard(text, successMessage);
                });
            } else {
                fallbackCopyToClipboard(text, successMessage);
            }
        }

        function fallbackCopyToClipboard(text, successMessage) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification(successMessage);
            } catch (err) {
                showNotification('Error al copiar. Copia manualmente: ' + text, 'error');
            }
            
            document.body.removeChild(textArea);
        }

        function toggleParticipation() {
            participationActive = !participationActive;
            
            const btn = document.getElementById('toggleParticipationBtn');
            if (participationActive) {
                btn.textContent = '‚úÖ Participaci√≥n activa';
                btn.classList.remove('inactive');
            } else {
                btn.textContent = '‚è∏Ô∏è Participaci√≥n pausada';
                btn.classList.add('inactive');
            }
            
            updateParticipationStatus();
            
            // Broadcast to all participants
            broadcastMessage({
                type: 'participationToggle',
                active: participationActive
            });
            
            showNotification(participationActive ? 'Participaci√≥n reactivada' : 'Participaci√≥n pausada');
        }

        function updateParticipationStatus() {
            const notice = document.getElementById('participationNotice');
            const formSection = document.getElementById('evidenceFormSection');
            
            if (!participationActive && !isPresenter) {
                notice.style.display = 'block';
                formSection.style.opacity = '0.5';
                formSection.style.pointerEvents = 'none';
            } else {
                notice.style.display = 'none';
                formSection.style.opacity = '1';
                formSection.style.pointerEvents = 'auto';
            }
        }

        function updateParticipantCount() {
            document.getElementById('participantCountDisplay').textContent = `${connections.length} conectados`;
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status === 'connected' ? 'Conectado' : 'Desconectado';
            statusElement.className = `connection-status ${status}`;
        }

        function broadcastMessage(message) {
            connections.forEach(conn => {
                if (conn.open) {
                    conn.send(message);
                }
            });
        }

        function broadcastConfigUpdate() {
            broadcastMessage({
                type: 'configUpdate',
                config: sessionConfig
            });
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Update summary display when switching to summary tab
            if (tabName === 'resumen') {
                updateSummaryDisplay();
            }
        }

        function updateThemeColor(color) {
            document.documentElement.style.setProperty('--primary-color', color);
            
            // Calculate lighter and darker variants
            const lightColor = lightenColor(color, 40);
            const darkColor = darkenColor(color, 20);
            
            document.documentElement.style.setProperty('--primary-light', lightColor);
            document.documentElement.style.setProperty('--primary-dark', darkColor);
            
            // Update session config
            sessionConfig.themeColor = color;
        }

        function lightenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        function darkenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return "#" + (0x1000000 + (R > 255 ? 255 : R < 0 ? 0 : R) * 0x10000 +
                (G > 255 ? 255 : G < 0 ? 0 : G) * 0x100 +
                (B > 255 ? 255 : B < 0 ? 0 : B)).toString(16).slice(1);
        }

        function addEvidence() {
            const title = document.getElementById('evidenceTitle').value.trim();
            const url = document.getElementById('evidenceUrl').value.trim();
            
            if (!title || !url) {
                showNotification('Por favor, completa todos los campos.', 'error');
                return;
            }

            const evidence = {
                id: Date.now(),
                title: title,
                url: url,
                timestamp: new Date().toLocaleString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }),
                color: cardColors[evidences.length % cardColors.length]
            };

            // Add to local evidences
            evidences.push(evidence);
            
            // Clear form
            document.getElementById('evidenceForm').reset();
            
            // Update displays
            updateDisplays();
            
            // Broadcast to connected peers
            if (isPresenter) {
                broadcastMessage({
                    type: 'evidence',
                    evidence: evidence
                });
            } else {
                // Send to presenter
                connections.forEach(conn => {
                    if (conn.open) {
                        conn.send({
                            type: 'evidence',
                            evidence: evidence
                        });
                    }
                });
            }
            
            // Show success message
            showNotification('¬°Evidencia enviada correctamente!');
        }

        function receiveEvidence(evidence) {
            evidences.push(evidence);
            updateDisplays();
            
            // If presenter, broadcast to all other participants
            if (isPresenter) {
                broadcastMessage({
                    type: 'evidence',
                    evidence: evidence
                });
            }
        }

        function updateDisplays() {
            updateEvidenceDisplay();
            updateSummaryDisplay();
        }

        function updateEvidenceDisplay() {
            const display = document.getElementById('evidenceDisplay');
            
            if (evidences.length === 0) {
                display.innerHTML = '<div class="no-evidence">No hay evidencias enviadas a√∫n. ¬°S√© el primero en compartir!</div>';
                return;
            }

            const html = evidences.slice().reverse().map(evidence => `
                <div class="evidence-card" style="border-left-color: ${evidence.color}; background-color: ${evidence.color};">
                    <h3>${escapeHtml(evidence.title)}</h3>
                    <p><a href="${escapeHtml(evidence.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(evidence.url)}</a></p>
                    <div class="timestamp">üìÖ ${evidence.timestamp}</div>
                </div>
            `).join('');

            display.innerHTML = html;
        }

        function updateSummaryDisplay() {
            const display = document.getElementById('summaryDisplay');
            
            if (evidences.length === 0) {
                display.innerHTML = '<div class="no-evidence">No hay evidencias para mostrar en el resumen.</div>';
                return;
            }

            // Sort by timestamp (most recent first)
            const sortedEvidences = evidences.slice().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const html = sortedEvidences.map(evidence => `
                <div class="evidence-card" style="border-left-color: ${evidence.color}; background-color: ${evidence.color};">
                    <h3>${escapeHtml(evidence.title)}</h3>
                    <p><a href="${escapeHtml(evidence.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(evidence.url)}</a></p>
                    <div class="timestamp">üìÖ ${evidence.timestamp}</div>
                </div>
            `).join('');

            display.innerHTML = html;
        }

        function exportToPDF() {
            if (evidences.length === 0) {
                alert('No hay evidencias para exportar.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.text('Repositorio de Evidencias de Formaci√≥n', 20, 30);
            
            doc.setFontSize(12);
            doc.text(`Generado el: ${new Date().toLocaleString('es-ES')}`, 20, 45);
            doc.text(`Total de evidencias: ${evidences.length}`, 20, 55);
            
            let yPosition = 75;
            
            evidences.forEach((evidence, index) => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 30;
                }
                
                doc.setFontSize(14);
                doc.text(`${index + 1}. ${evidence.title}`, 20, yPosition);
                
                doc.setFontSize(10);
                doc.text(`URL: ${evidence.url}`, 25, yPosition + 10);
                doc.text(`Fecha: ${evidence.timestamp}`, 25, yPosition + 20);
                
                yPosition += 35;
            });
            
            doc.save('evidencias-formacion.pdf');
            showNotification('PDF exportado correctamente');
        }

        function exportToCSV() {
            if (evidences.length === 0) {
                alert('No hay evidencias para exportar.');
                return;
            }

            const headers = ['T√≠tulo', 'URL', 'Fecha y Hora'];
            const csvContent = [
                headers.join(','),
                ...evidences.map(evidence => [
                    `"${evidence.title.replace(/"/g, '""')}"`,
                    `"${evidence.url}"`,
                    `"${evidence.timestamp}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'evidencias-formacion.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('CSV exportado correctamente');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function generateQRCode() {
            if (!sessionConfig.sessionId) {
                showNotification('Primero inicia la sesi√≥n como presentador', 'error');
                return;
            }
            
            const config = btoa(JSON.stringify({
                sessionId: sessionConfig.sessionId,
                themeColor: sessionConfig.themeColor,
                title: sessionConfig.title
            }));
            
            const link = `${window.location.origin}${window.location.pathname}?config=${config}`;
            
            // Clear previous QR code
            const container = document.getElementById('qrCodeContainer');
            container.innerHTML = '';
            
            // Generate QR code
            QRCode.toCanvas(link, {
                width: 256,
                height: 256,
                color: {
                    dark: sessionConfig.themeColor,
                    light: '#FFFFFF'
                }
            }, function (error, canvas) {
                if (error) {
                    showNotification('Error al generar el c√≥digo QR', 'error');
                    console.error(error);
                    return;
                }
                
                currentQRCanvas = canvas;
                container.appendChild(canvas);
                
                // Show modal
                document.getElementById('qrModal').style.display = 'flex';
            });
        }

        function downloadQR() {
            if (!currentQRCanvas) {
                showNotification('No hay c√≥digo QR para descargar', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.download = 'qr-sesion-evidencias.png';
            link.href = currentQRCanvas.toDataURL();
            link.click();
            
            showNotification('C√≥digo QR descargado');
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // Close modal when clicking outside
        document.getElementById('qrModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeQRModal();
            }
        });

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            
            let backgroundColor = '#10b981'; // success
            if (type === 'error') backgroundColor = '#ef4444';
            if (type === 'warning') backgroundColor = '#f59e0b';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${backgroundColor};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'968517c586b2cbe3',t:'MTc1NDA0ODc2My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><iframe height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: medium; visibility: hidden;"></iframe>


</body></html>
