<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repositorio de Evidencias de Nuestra Formaci√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3b82f6;
            --primary-light: #93c5fd;
            --primary-dark: #1d4ed8;
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-color) 0%, #e2e8f0 100%);
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .session-control-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--primary-color);
        }

        .session-control-panel h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }

        .session-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .session-info-item {
            text-align: center;
        }

        .session-info-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .session-id-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .session-id {
            font-family: monospace;
            background: #f1f5f9;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid var(--primary-light);
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .copy-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .session-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-panel {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid var(--primary-light);
        }

        .role-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0 0 0;
        }

        .role-btn {
            padding: 10px 20px;
            border: 2px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .role-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .role-btn:hover:not(.active) {
            background: var(--primary-light);
            color: white;
        }

        .presenter-controls, .participant-controls {
            text-align: center;
        }

        .theme-selector {
            margin: 20px 0;
        }

        .theme-selector label {
            font-weight: 600;
            margin-right: 10px;
        }

        .color-picker {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .session-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--primary-color);
            color: white;
        }

        .control-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .control-btn.inactive {
            background: #ef4444;
        }

        .control-btn.inactive:hover {
            background: #dc2626;
        }

        .session-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.9rem;
        }

        .participant-count {
            color: #64748b;
            font-weight: 600;
        }

        .connection-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .session-input {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            font-family: monospace;
            width: 250px;
        }

        .session-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .connection-status {
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .connection-status.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .connection-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .participation-notice {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            color: #92400e;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--text-color);
        }

        .tab-button.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: var(--primary-light);
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid var(--primary-light);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .submit-btn {
            background: var(--primary-color);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .evidence-display {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            background: #fafafa;
        }

        .evidence-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 5px solid;
            transition: transform 0.2s ease;
        }

        .evidence-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .evidence-card h3 {
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 1.2rem;
        }

        .evidence-card a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            word-break: break-all;
        }

        .evidence-card a:hover {
            text-decoration: underline;
        }

        .evidence-card .timestamp {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 10px;
            font-style: italic;
        }

        .export-section {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: #10b981;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .export-btn.pdf {
            background: #dc2626;
        }

        .export-btn.pdf:hover {
            background: #b91c1c;
        }

        .no-evidence {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 40px;
        }

        .card-colors {
            --card-1: #fef3c7;
            --card-2: #ddd6fe;
            --card-3: #fce7f3;
            --card-4: #d1fae5;
            --card-5: #fed7d7;
            --card-6: #bfdbfe;
            --card-7: #fde68a;
            --card-8: #c7d2fe;
        }

        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .qr-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .qr-modal h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .qr-code-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }

        .qr-modal .control-btn {
            margin: 10px 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .export-section {
                flex-direction: column;
            }

            .session-info-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .session-actions {
                flex-direction: column;
                align-items: center;
            }

            .session-actions .control-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Repositorio de Evidencias de Nuestra Formaci√≥n</h1>
            <p>Recopila y comparte evidencias de aprendizaje en tiempo real</p>
            
            <div class="role-selector">
                <button id="presenterBtn" class="role-btn active">üë®‚Äçüè´ Presentador</button>
                <button id="participantBtn" class="role-btn">üë• Participante</button>
            </div>
        </div>

        <div id="sessionControlPanel" class="session-control-panel" style="display: block;">
            <h3>üéõÔ∏è Control de Sesi√≥n</h3>
            <div class="session-info-grid">
                <div class="session-info-item">
                    <label>ID de Sesi√≥n:</label>
                    <div class="session-id-display">
                        <!-- CAMBIO: Texto inicial modificado para ser m√°s claro -->
                        <span id="sessionIdDisplay" class="session-id">Pulse "Presentador" para iniciar</span>
                        <button id="copySessionIdBtn" class="copy-btn" title="Copiar ID">üìã</button>
                    </div>
                </div>
                <div class="session-info-item">
                    <label>Participantes:</label>
                    <span id="participantCountDisplay" class="participant-count">0 conectados</span>
                </div>
            </div>
            <div class="session-actions">
                <button id="generateLinkBtn" class="control-btn">üîó Generar enlace de sesi√≥n</button>
                <button id="generateQRBtn" class="control-btn">üì± Generar QR para participantes</button>
                <button id="toggleParticipationBtn" class="control-btn active">‚úÖ Participaci√≥n activa</button>
            </div>
        </div>

        <div class="control-panel">
                
                <div id="presenterControls" class="presenter-controls">
                    <div class="theme-selector">
                        <label for="colorPicker">Color del tema:</label>
                        <input type="color" id="colorPicker" class="color-picker" value="#3b82f6">
                    </div>
                </div>
                
                <div id="participantControls" class="participant-controls" style="display: none;">
                    <div class="connection-section">
                        <input type="text" id="sessionIdInput" placeholder="Introduce el ID de sesi√≥n" class="session-input">
                        <button id="connectBtn" class="control-btn">üîå Conectar a sesi√≥n</button>
                        <div id="connectionStatus" class="connection-status disconnected">Desconectado</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('evidencias')">üìù Evidencias</button>
            <button class="tab-button" onclick="switchTab('resumen')">üìä Resumen Final</button>
        </div>

        <div id="evidencias" class="tab-content active">
            <h2 style="margin-bottom: 20px; color: var(--primary-color);">Nuestras evidencias del aprendizaje en esta formaci√≥n</h2>
            
            <div id="participationNotice" class="participation-notice" style="display: none;">
                <p>‚è∏Ô∏è La participaci√≥n est√° pausada por el presentador. Espera a que se reactive para enviar evidencias.</p>
            </div>

            <div class="form-section" id="evidenceFormSection">
                <form id="evidenceForm">
                    <div class="form-group">
                        <label for="evidenceTitle">T√≠tulo de la Evidencia:</label>
                        <input type="text" id="evidenceTitle" required placeholder="Ej: Proyecto final de m√≥dulo 1">
                    </div>
                    
                    <div class="form-group">
                        <label for="evidenceUrl">URL de la Evidencia:</label>
                        <input type="url" id="evidenceUrl" required placeholder="https://ejemplo.com/mi-evidencia">
                    </div>
                    
                    <button type="submit" class="submit-btn">üì§ Enviar mi evidencia</button>
                </form>
            </div>

            <div class="evidence-display" id="evidenceDisplay">
                <div class="no-evidence">No hay evidencias enviadas a√∫n. ¬°S√© el primero en compartir!</div>
            </div>
        </div>

        <div id="resumen" class="tab-content">
            <h2 style="margin-bottom: 20px; color: var(--primary-color);">Resumen Final de Evidencias</h2>
            
            <div class="export-section">
                <button class="export-btn pdf" onclick="exportToPDF()">üìÑ Exportar a PDF</button>
                <button class="export-btn" onclick="exportToCSV()">üìä Exportar a CSV</button>
            </div>

            <div class="evidence-display" id="summaryDisplay">
                <div class="no-evidence">No hay evidencias para mostrar en el resumen.</div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="qrModal" class="qr-modal">
        <div class="qr-modal-content">
            <h3>üì± C√≥digo QR para Participantes</h3>
            <p>Escanea este c√≥digo para unirte a la sesi√≥n:</p>
            <div class="qr-code-container" id="qrCodeContainer"></div>
            <div>
                <button class="control-btn" onclick="downloadQR()">üíæ Descargar QR</button>
                <button class="control-btn" onclick="closeQRModal()">‚ùå Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let evidences = [];
        const cardColors = ['#fef3c7', '#ddd6fe', '#fce7f3', '#d1fae5', '#fed7d7', '#bfdbfe', '#fde68a', '#c7d2fe'];
        let peer = null;
        let connections = [];
        let isPresenter = true;
        let participationActive = true;
        let sessionConfig = {
            themeColor: '#3b82f6',
            title: 'Repositorio de Evidencias de Nuestra Formaci√≥n'
        };
        let currentQRCanvas = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadConfigFromURL();
        });

        function initializeApp() {
            updateDisplays();
            updateRoleDisplay();
            
            // Load theme color from session config
            const savedColor = sessionConfig.themeColor;
            document.getElementById('colorPicker').value = savedColor;
            updateThemeColor(savedColor);
            
            // CAMBIO: La inicializaci√≥n del presentador ya no ocurre aqu√≠.
            // Se activar√° cuando el usuario seleccione el rol de presentador.
            // initializePresenter(); 
        }

        function setupEventListeners() {
            // Role selection
            document.getElementById('presenterBtn').addEventListener('click', () => switchRole(true));
            document.getElementById('participantBtn').addEventListener('click', () => switchRole(false));
            
            // Theme color picker
            document.getElementById('colorPicker').addEventListener('change', function(e) {
                updateThemeColor(e.target.value);
                if (isPresenter) {
                    sessionConfig.themeColor = e.target.value;
                    broadcastConfigUpdate();
                }
            });

            // Presenter controls
            document.getElementById('generateLinkBtn').addEventListener('click', generateSessionLink);
            document.getElementById('generateQRBtn').addEventListener('click', generateQRCode);
            document.getElementById('toggleParticipationBtn').addEventListener('click', toggleParticipation);
            document.getElementById('copySessionIdBtn').addEventListener('click', copySessionId);
            
            // Participant controls
            document.getElementById('connectBtn').addEventListener('click', connectToSession);

            // Form submission
            document.getElementById('evidenceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (participationActive || isPresenter) {
                    addEvidence();
                } else {
                    showNotification('La participaci√≥n est√° pausada', 'warning');
                }
            });
        }

        function loadConfigFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const config = urlParams.get('config');
            
            if (config) {
                try {
                    const decodedConfig = JSON.parse(atob(config));
                    sessionConfig = { ...sessionConfig, ...decodedConfig };
                    
                    // Apply loaded configuration
                    document.getElementById('colorPicker').value = sessionConfig.themeColor;
                    updateThemeColor(sessionConfig.themeColor);
                    
                    if (sessionConfig.sessionId) {
                        document.getElementById('sessionIdInput').value = sessionConfig.sessionId;
                        switchRole(false); // Switch to participant mode
                        setTimeout(() => connectToSession(), 1000);
                    }
                } catch (e) {
                    console.error('Error loading configuration:', e);
                }
            }
        }

        function switchRole(presenter) {
            isPresenter = presenter;
            
            // Update button states
            document.getElementById('presenterBtn').classList.toggle('active', presenter);
            document.getElementById('participantBtn').classList.toggle('active', !presenter);
            
            updateRoleDisplay();
            
            if (presenter) {
                // Only initialize if not already initialized or if switching from participant
                if (!peer || !sessionConfig.sessionId) {
                    initializePresenter();
                }
            } else {
                initializeParticipant();
            }
        }

        function updateRoleDisplay() {
            const presenterControls = document.getElementById('presenterControls');
            const participantControls = document.getElementById('participantControls');
            const sessionControlPanel = document.getElementById('sessionControlPanel');
            
            if (presenterControls) presenterControls.style.display = isPresenter ? 'block' : 'none';
            if (participantControls) participantControls.style.display = isPresenter ? 'none' : 'block';
            if (sessionControlPanel) sessionControlPanel.style.display = isPresenter ? 'block' : 'none';
            
            // Update form section visibility based on participation status
            updateParticipationStatus();
        }

        function initializePresenter() {
            if (peer) {
                peer.destroy();
            }
            
            // Show loading state
            const sessionIdElement = document.getElementById('sessionIdDisplay');
            if (sessionIdElement) {
                sessionIdElement.textContent = 'Generando...';
            }
            
            peer = new Peer();
            
            peer.on('open', function(id) {
                if (sessionIdElement) {
                    sessionIdElement.textContent = id;
                }
                sessionConfig.sessionId = id;
                showNotification('‚úÖ Sesi√≥n iniciada - ID: ' + id.substring(0, 8) + '...');
                console.log('Session ID generated:', id);
            });
            
            peer.on('error', function(err) {
                console.error('Peer error:', err);
                if (sessionIdElement) {
                    sessionIdElement.textContent = 'Error - Reintentando...';
                }
                showNotification('Error al generar ID. Reintentando...', 'warning');
                
                // Retry after 2 seconds
                setTimeout(() => {
                    initializePresenter();
                }, 2000);
            });
            
            peer.on('connection', function(conn) {
                connections.push(conn);
                updateParticipantCount();
                showNotification('üîó Nuevo participante conectado');
                
                conn.on('data', function(data) {
                    if (data.type === 'evidence') {
                        receiveEvidence(data.evidence);
                    }
                });
                
                conn.on('close', function() {
                    connections = connections.filter(c => c !== conn);
                    updateParticipantCount();
                    showNotification('üëã Participante desconectado', 'warning');
                });
                
                // Send current configuration to new participant
                conn.on('open', () => {
                    conn.send({
                        type: 'config',
                        config: sessionConfig,
                        participationActive: participationActive,
                        evidences: evidences
                    });
                });
            });
        }

        function initializeParticipant() {
            if (peer) {
                peer.destroy();
            }
            
            peer = new Peer();
            updateConnectionStatus('disconnected');
            
            peer.on('error', function(err) {
                console.error('Participant peer error:', err);
                showNotification('Error de red de participante. Intente de nuevo.', 'error');
            });
        }

        function connectToSession() {
            const sessionId = document.getElementById('sessionIdInput').value.trim();
            
            if (!sessionId) {
                showNotification('Introduce un ID de sesi√≥n v√°lido', 'error');
                return;
            }
            
            if (!peer || peer.destroyed) {
                initializeParticipant();
                 // Give peer time to initialize before connecting
                setTimeout(() => connectToSession(), 1000);
                return;
            }
            
            // If peer is not open yet, wait for it.
            if (!peer.open) {
                peer.on('open', function() {
                    connectToSession();
                });
                return;
            }

            const conn = peer.connect(sessionId);
            
            conn.on('open', function() {
                connections = [conn];
                updateConnectionStatus('connected');
                showNotification('Conectado a la sesi√≥n');
            });
            
            conn.on('data', function(data) {
                if (data.type === 'config') {
                    sessionConfig = data.config;
                    participationActive = data.participationActive;
                    evidences = data.evidences || [];
                    
                    // Apply received configuration
                    updateThemeColor(sessionConfig.themeColor);
                    updateParticipationStatus();
                    updateDisplays();
                } else if (data.type === 'evidence') {
                    receiveEvidence(data.evidence);
                } else if (data.type === 'participationToggle') {
                    participationActive = data.active;
                    updateParticipationStatus();
                } else if (data.type === 'configUpdate') {
                    sessionConfig = { ...sessionConfig, ...data.config };
                    updateThemeColor(sessionConfig.themeColor);
                }
            });
            
            conn.on('close', function() {
                connections = [];
                updateConnectionStatus('disconnected');
                showNotification('Desconectado de la sesi√≥n', 'warning');
            });
            
            conn.on('error', function(err) {
                updateConnectionStatus('disconnected');
                showNotification('Error de conexi√≥n: ' + err.message, 'error');
            });
        }

        function generateSessionLink() {
            if (!sessionConfig.sessionId) {
                showNotification('Primero inicia la sesi√≥n como presentador', 'error');
                return;
            }
            
            const config = btoa(JSON.stringify({
                sessionId: sessionConfig.sessionId,
                themeColor: sessionConfig.themeColor,
                title: sessionConfig.title
            }));
            
            const link = `${window.location.origin}${window.location.pathname}?config=${config}`;
            
            copyToClipboard(link, 'Enlace copiado al portapapeles');
        }

        function copySessionId() {
            if (!sessionConfig.sessionId || sessionIdDisplay.textContent.includes('...')) {
                showNotification('No hay ID de sesi√≥n disponible', 'error');
                return;
            }
            
            copyToClipboard(sessionConfig.sessionId, 'ID de sesi√≥n copiado');
        }

        function copyToClipboard(text, successMessage) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification(successMessage);
                }).catch(() => {
                    fallbackCopyToClipboard(text, successMessage);
                });
            } else {
                fallbackCopyToClipboard(text, successMessage);
            }
        }

        function fallbackCopyToClipboard(text, successMessage) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification(successMessage);
            } catch (err) {
                showNotification('Error al copiar', 'error');
            }
            document.body.removeChild(textArea);
        }

        // --- The rest of the functions (addEvidence, updateDisplays, etc.) remain the same ---
        // --- They are omitted here for brevity but are included in the full code ---

        function updateDisplays() {
            renderEvidence();
            updateParticipantCount();
        }

        function updateParticipantCount() {
            const count = isPresenter ? connections.length : (connections.length > 0 ? 1 : 0);
            const display = document.getElementById('participantCountDisplay');
            if(display) {
                display.textContent = `${count} conectado(s)`;
            }
        }

        function updateConnectionStatus(status) {
            const statusDiv = document.getElementById('connectionStatus');
            if(statusDiv) {
                statusDiv.textContent = status === 'connected' ? '‚úÖ Conectado' : 'üîå Desconectado';
                statusDiv.className = `connection-status ${status}`;
            }
        }

        function addEvidence() {
            const title = document.getElementById('evidenceTitle').value;
            const url = document.getElementById('evidenceUrl').value;

            if (title && url) {
                const newEvidence = {
                    id: Date.now(),
                    title: title,
                    url: url,
                    timestamp: new Date().toLocaleString()
                };

                if (isPresenter) {
                    receiveEvidence(newEvidence);
                    broadcastEvidence(newEvidence);
                } else {
                    sendEvidenceToServer(newEvidence);
                }
                document.getElementById('evidenceForm').reset();
            }
        }

        function receiveEvidence(evidence) {
            evidences.push(evidence);
            updateDisplays();
        }

        function sendEvidenceToServer(evidence) {
            if (connections.length > 0) {
                connections[0].send({ type: 'evidence', evidence: evidence });
                showNotification('Evidencia enviada correctamente');
            } else {
                showNotification('No est√°s conectado a una sesi√≥n', 'error');
            }
        }

        function broadcastEvidence(evidence) {
            connections.forEach(conn => {
                conn.send({ type: 'evidence', evidence: evidence });
            });
        }

        function broadcastConfigUpdate() {
            connections.forEach(conn => {
                conn.send({ type: 'configUpdate', config: { themeColor: sessionConfig.themeColor } });
            });
        }

        function renderEvidence() {
            const display = document.getElementById('evidenceDisplay');
            const summaryDisplay = document.getElementById('summaryDisplay');
            
            display.innerHTML = '';
            summaryDisplay.innerHTML = '';

            if (evidences.length === 0) {
                display.innerHTML = '<div class="no-evidence">No hay evidencias enviadas a√∫n. ¬°S√© el primero en compartir!</div>';
                summaryDisplay.innerHTML = '<div class="no-evidence">No hay evidencias para mostrar en el resumen.</div>';
                return;
            }

            evidences.forEach((evidence, index) => {
                const cardColor = cardColors[index % cardColors.length];
                const card = document.createElement('div');
                card.className = 'evidence-card';
                card.style.borderColor = cardColor;
                card.innerHTML = `
                    <h3>${escapeHTML(evidence.title)}</h3>
                    <p><a href="${escapeHTML(evidence.url)}" target="_blank" rel="noopener noreferrer">${escapeHTML(evidence.url)}</a></p>
                    <div class="timestamp">Enviado: ${escapeHTML(evidence.timestamp)}</div>
                `;
                display.appendChild(card.cloneNode(true));
                summaryDisplay.appendChild(card);
            });
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(button => button.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }

        function exportToPDF() {
            if (evidences.length === 0) {
                showNotification('No hay evidencias para exportar', 'warning');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 15;
            doc.setFontSize(18);
            doc.text('Resumen de Evidencias', 10, y);
            y += 10;
            evidences.forEach(e => {
                if (y > 280) { // New page
                    doc.addPage();
                    y = 15;
                }
                doc.setFontSize(12);
                doc.text(`T√≠tulo: ${e.title}`, 10, y);
                y += 7;
                doc.setFontSize(10);
                doc.textWithLink(`URL: ${e.url}`, 10, y, { url: e.url });
                y += 5;
                doc.setFontSize(8);
                doc.text(`Fecha: ${e.timestamp}`, 10, y);
                y += 10;
            });
            doc.save('resumen_evidencias.pdf');
        }

        function exportToCSV() {
            if (evidences.length === 0) {
                showNotification('No hay evidencias para exportar', 'warning');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,T√≠tulo,URL,Fecha\n";
            evidences.forEach(e => {
                csvContent += `"${e.title.replace(/"/g, '""')}","${e.url}","${e.timestamp}"\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "resumen_evidencias.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateThemeColor(color) {
            document.documentElement.style.setProperty('--primary-color', color);
            const newPrimaryLight = color + '80'; // Example of generating a lighter shade
            const newPrimaryDark = pSBC(-0.3, color);
            document.documentElement.style.setProperty('--primary-light', newPrimaryLight);
            if(newPrimaryDark) document.documentElement.style.setProperty('--primary-dark', newPrimaryDark);
        }

        function toggleParticipation() {
            participationActive = !participationActive;
            updateParticipationStatus();
            connections.forEach(conn => {
                conn.send({ type: 'participationToggle', active: participationActive });
            });
            showNotification(participationActive ? 'Participaci√≥n reactivada' : 'Participaci√≥n pausada');
        }

        function updateParticipationStatus() {
            const btn = document.getElementById('toggleParticipationBtn');
            const notice = document.getElementById('participationNotice');
            const formSection = document.getElementById('evidenceFormSection');

            if (isPresenter) {
                if (btn) {
                    btn.textContent = participationActive ? '‚úÖ Participaci√≥n activa' : '‚è∏Ô∏è Pausar participaci√≥n';
                    btn.classList.toggle('inactive', !participationActive);
                }
            } else {
                if (notice) notice.style.display = participationActive ? 'none' : 'block';
                if (formSection) formSection.style.display = participationActive ? 'block' : 'none';
            }
        }
        
        function generateQRCode() {
            if (!sessionConfig.sessionId) {
                showNotification('Primero inicia la sesi√≥n como presentador', 'error');
                return;
            }
            const config = btoa(JSON.stringify({ sessionId: sessionConfig.sessionId, themeColor: sessionConfig.themeColor, title: sessionConfig.title }));
            const link = `${window.location.origin}${window.location.pathname}?config=${config}`;
            
            const qrContainer = document.getElementById('qrCodeContainer');
            qrContainer.innerHTML = '';
            
            QRCode.toCanvas(link, { width: 256, errorCorrectionLevel: 'H' }, function (err, canvas) {
                if (err) {
                    console.error(err);
                    showNotification('Error al generar el c√≥digo QR', 'error');
                    return;
                }
                currentQRCanvas = canvas;
                qrContainer.appendChild(canvas);
                document.getElementById('qrModal').style.display = 'flex';
            });
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
            currentQRCanvas = null;
        }

        function downloadQR() {
            if (currentQRCanvas) {
                const link = document.createElement('a');
                link.download = 'session-qr-code.png';
                link.href = currentQRCanvas.toDataURL('image/png');
                link.click();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            Object.assign(notification.style, {
                position: 'fixed',
                bottom: '20px',
                right: '20px',
                padding: '15px 20px',
                borderRadius: '8px',
                color: 'white',
                background: type === 'success' ? '#10b981' : (type === 'warning' ? '#f59e0b' : '#ef4444'),
                zIndex: '1001',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                opacity: '0',
                transition: 'opacity 0.3s, transform 0.3s',
                transform: 'translateY(10px)'
            });
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 10);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(10px)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function (match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }

        // Function to darken/lighten a color (Positive lighten, Negative darken)
        const pSBC=(p,c0,c1,l)=>{
            let r,g,b,P,f,t,h,i=parseInt,m=Math.round,a=typeof(c1)=="string";
            if(typeof(p)!="number"||p<-1||p>1||typeof(c0)!="string"||(c0[0]!='r'&&c0[0]!='#')||(c1&&!a))return null;
            if(!this.pSBCr)this.pSBCr=(d)=>{
                let n=d.length,x={};
                if(n>9){
                    [r,g,b,a]=d=d.split(","),n=d.length;
                    if(n<3||n>4)return null;
                    x.r=i(r[3]=="a"?r.slice(5):r.slice(4)),x.g=i(g),x.b=i(b),x.a=a?parseFloat(a):-1
                }else{
                    if(n==8||n==6||n<4)return null;
                    if(n<5)d="#"+d[1]+d[1]+d[2]+d[2]+d[3]+d[3]+(n>4?d[4]+d[4]:"");
                    d=i(d.slice(1),16);
                    if(n==9||n==5)x.r=d>>24&255,x.g=d>>16&255,x.b=d>>8&255,x.a=m((d&255)/0.255)/1000;
                    else x.r=d>>16,x.g=d>>8&255,x.b=d&255,x.a=-1
                }return x};
            h=c0.length>9,h=a?c1.length>9?true:c1=="c"?!h:false:h,f=this.pSBCr(c0),P=p<0,t=c1&&c1!="c"?this.pSBCr(c1):P?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1},p=P?p*-1:p,P=1-p;
            if(!f||!t)return null;
            if(l)r=m(P*f.r+p*t.r),g=m(P*f.g+p*t.g),b=m(P*f.b+p*t.b);
            else r=m((P*f.r**2+p*t.r**2)**0.5),g=m((P*f.g**2+p*t.g**2)**0.5),b=m((P*f.b**2+p*t.b**2)**0.5);
            a=f.a,t=t.a,f=a>=0||t>=0,a=f?a<0?t:t<0?a:a*P+p*t:0;
            if(h)return"rgb"+(f?"a(":"(")+r+","+g+","+b+(f?","+m(a*1000)/1000:"")+")";
            else return"#"+(4294967296+r*16777216+g*65536+b*256+(f?m(a*255):0)).toString(16).slice(1,f?undefined:-2)
        }
    </script>
</body>
</html>
